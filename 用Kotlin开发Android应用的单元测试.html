<!DOCTYPE html>
<html lang="zh_cn">
<head>
        <title>iknockdoor-用Kotlin开发Android应用的单元测试</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" type="text/css" href="http://www.iknockdoor.com/theme/css/org.css" />
        <link rel="stylesheet" type="text/css" href="http://www.iknockdoor.com/theme/css/custom.css" />
        <link href="http://www.iknockdoor.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="iknockdoor Full Atom Feed" />


<script>var _gaq=[['_setAccount','UA-103057848-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
        <!-- mathjax config similar to math.stackexchange -->
	<script type="text/x-mathjax-config">
	  MathJax.Hub.Config({
	  jax: ["input/TeX", "output/HTML-CSS"],
	  tex2jax: {
	  inlineMath: [ ['$', '$'] ],
	  displayMath: [ ['$$', '$$']],
	  processEscapes: true,
	  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
	  },
	  messageStyle: "none",
	  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
	  });
	</script>
</head>

<body id="index" class="home">
  <div id="banner"><div id="banner-inside">
      <nav id="menu">
      <header id="site_name">
                iknockdoor
        </header><!-- /#banner -->
          <ul>
            <li><a href="http://www.iknockdoor.com/index.html">Index</a></li>
            <li><a href="http://www.iknockdoor.com/categories.html">Categories</a></li>
            <li><a href="http://www.iknockdoor.com/tags.html">Tags</a></li>
            <li><a href="http://www.iknockdoor.com/archives.html">Archives</a></li>
      </ul></nav><!-- /#menu -->
  </div></div>
  <div id="content">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://www.iknockdoor.com/用Kotlin开发Android应用的单元测试.html" rel="bookmark"
         title="Permalink to 用Kotlin开发Android应用的单元测试">用Kotlin开发Android应用的单元测试</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2021-05-03T00:00:00+08:00">
      2021.05.03 星期一
    </time>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Junit5</h2>
<div class="outline-text-2" id="text-1">
<p>
搞清楚的各个包的关系，以及执行顺序基本上就没问题了。
</p>
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> 被迫使用jvm 1.8</h3>
<div class="outline-text-3" id="text-1-1">
<p>
参数化测试被迫使用了jvm 1.8，Stream.of方法，Arguments.of方法不用编译不过
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> 换回JUnit4</h3>
<div class="outline-text-3" id="text-1-2">
<p>
由于以下问题，我选择了换回JUnit4
</p>
<ul class="org-ul">
<li>jvm 1.8的问题，没搞清楚，有点担心
</li>
<li>无法使用Robolectric
</li>
<li>Android官方资料基本上都使用JUnit4写的，有得参考
</li>
<li>官方说仪器测试也是基于JUnit4的，谁知道后面有没有问题
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> 又换回JUnit5</h3>
<div class="outline-text-3" id="text-1-3">
<p>
换回JUnit4之后，发现执行效率比JUnit5低很多，尤其是参数测试，都无法接受
</p>
<ul class="org-ul">
<li>JUnit4效率太低
</li>
<li>一个测试类中，只要有一个方法需要参数化测试，其他方法都会被参数化测试，不管用不用到参数，这效率很低，而且毫无用处
</li>
<li>JUnit4无法显示DisplayName
</li>
<li>LiveData的本地测试问题得以解决
<a href="https://jeroenmols.com/blog/2019/01/17/livedatajunit5/">https://jeroenmols.com/blog/2019/01/17/livedatajunit5/</a>
</li>
<li>考虑本地测试用JUnit5，仪器测试用JUnit4的方案是否可行，事实上仪器测试并不是大头，所以还是以本地测试的效率为主，还是用JUnit5好事实证明可以本地用JUnit5仪器用JUnit4
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Mockito</h2>
<div class="outline-text-2" id="text-2">
<p>
挺好用的，系统的类也是可以mock的，但用Kotlin开发就有点尴尬，因为
Kotlin即使是自己写的类也都是final的，无法mock，如果能直接mock应该会简单一些，可以通过直接创建自己写的Kotlin的实现的类的对象测试，然后这些对象对系统的依赖进行注入，稍稍有点麻烦。
</p>

<p>
  也需要jvm<sub>1</sub>.8
  Execution failed for task ':app:mergeExtDexDebugAndroidTest'.
&gt; Could not resolve all files for configuration ':app:debugAndroidTestRuntimeClasspath'.
   &gt; Failed to transform mockito-core-3.9.0.jar (org.mockito:mockito-core:3.9.0) to match attributes {artifactType=android-dex, dexing-enable-desugaring=false, dexing-incremental-transform=false, dexing-is-debuggable=true, dexing-min-sdk=19, org.gradle.category=library, org.gradle.libraryelements=jar, org.gradle.status=release, org.gradle.usage=java-runtime}.
      &gt; Execution failed for DexingNoClasspathTransform: <i>Users/chappie</i>.gradle/caches/transforms-2/files-2.1/6319f7e3ae7c2113bdb38d4b79aea8fd/jetified-mockito-core-3.9.0.jar.
         &gt; Error while dexing.
           The dependency contains Java 8 bytecode. Please enable desugaring by adding the following to build.gradle
           android {
               compileOptions {
                   sourceCompatibility 1.8
                   targetCompatibility 1.8
               }
           }
           See <a href="https://developer.android.com/studio/write/java8-support.html">https://developer.android.com/studio/write/java8-support.html</a> for details. Alternatively, increase the minSdkVersion to 24 or above.
</p>
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> mock-inline是什么，有什么影响</h3>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> android.jar</h2>
<div class="outline-text-2" id="text-3">
<p>
自己的类实现中内部调用了android 系统API的方法，比如
Looper.getMainLooper()，由于是内部调用，无法从外部mock然后注入，同时
android.jar只有接口无具体实现，导致在开发环境中无法进行测试。这个问题怎么解决？
</p>
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> android-test Android官方codelabs给的启示</h3>
<div class="outline-text-3" id="text-3-1">
<p>
官方代码里面涉及到LiveData的代码居然是本地可测的，没有用Robolectric，通过排除法，找到了关键
testImplementation
"androidx.arch.core:core-testing:$archTestingVersion"
@get:Rule
 var instantExecutorRule = InstantTaskExecutorRule()
</p>

<p>
看InstantTaskExecutorRule的源码，关键问题应该是在主线程运行
LiveData，这样就不会调用到系统API的方法。尝试一下。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 依赖注入</h2>
<div class="outline-text-2" id="text-4">
<p>
单元测试无法避开的话题就是依赖注入，要想实现单元测试，就需要代码有足够的隔离，这要求类内部尽量少的去自动获取其他组合对象，因为这样的话被测试的代码就会对这些组合对象产生依赖，这带来的问题是：
</p>
<ol class="org-ol">
<li>如果是自己的代码，那还好，可以运行，如果是Android系统的代码，那就无法本地测试了，因为根本无法获取，也无法mock
</li>
<li>无法改变组合对象的行为，制造虚拟的测试条件，测试都是通过假设，断言，但是现在无法做假设了
</li>
</ol>
<p>
可以说实现单元测试的主要难点不是会不会用JUnit,Mockito而是被测试的代码结构是否是可以方便的单元测试的。
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 类组合的方式</h3>
<div class="outline-text-3" id="text-4-1">
<ol class="org-ol">
<li>内部主动创建
</li>
<li>内部从其他提供者处抓取
</li>
<li>构造函数注入
</li>
<li>调用某方法时传入
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 依赖注入与工厂方法的矛盾</h3>
<div class="outline-text-3" id="text-4-2">
<p>
我们通常会实现私有构造函数，然后通过内部静态方法构造实例的工厂方法来获取实例，这种情况都不知道怎么测试，工厂方法无法被mock，通过其他方式又无法构造私有构造函数类的实例。
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 小技巧</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 快速执行当前测试用例</h3>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> 执行所有的测试用例</h3>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> 单元测试要测的不只是逻辑的正确性，而是代码在修改后，依然是预期的输入输出或行为，更像函数式编程的不可变性</h3>
</div>
</div>

  </div><!-- /.entry-content -->
  <footer class="post-info-footer">
        Category: <a href="http://www.iknockdoor.com/category/wei-fen-lei.html"><span>未分类</span></a>
  </footer>
</section>
        </div>
        <footer id="contentinfo" class="body">
          © 2017-2020 iknockdoor</address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>